<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Theater Production System Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #f39c12;
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .panel {
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }
        .panel h3 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .agent-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .agent-card {
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            transition: border-color 0.3s;
        }
        .agent-card:hover {
            border-color: #3498db;
        }
        .agent-card.connected {
            border-color: #27ae60;
        }
        .agent-name {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .agent-role {
            color: #95a5a6;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .agent-status {
            font-size: 0.8em;
        }
        .status-ready { color: #27ae60; }
        .status-initializing { color: #f39c12; }
        .status-error { color: #e74c3c; }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        .log {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-timestamp {
            color: #95a5a6;
        }
        .log-agent {
            color: #3498db;
            font-weight: bold;
        }
        .log-message {
            color: #e0e0e0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .metric {
            text-align: center;
            padding: 15px;
            background: #34495e;
            border-radius: 6px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #f39c12;
        }
        .metric-label {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ­ AI Theater Production System</h1>
        
        <div class="dashboard">
            <div class="panel">
                <h3>ðŸ“Š System Status</h3>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="agent-count">0</div>
                        <div class="metric-label">Agents</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="event-count">0</div>
                        <div class="metric-label">Events</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="production-count">0</div>
                        <div class="metric-label">Productions</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="active-tasks">0</div>
                        <div class="metric-label">Active Tasks</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="current-phase">None</div>
                        <div class="metric-label">Current Phase</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="health-status">Unknown</div>
                        <div class="metric-label">Health</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>ðŸŽ¬ Quick Actions</h3>
                <div class="controls">
                    <button id="init-system" onclick="initializeSystem()">Initialize System</button>
                    <button id="start-production" onclick="startDemoProduction()" disabled>Start Demo Production</button>
                    <button id="view-agents" onclick="toggleAgentView()">Toggle Agent View</button>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h3>ðŸŽ­ Theater Agents</h3>
            <div id="agent-list" class="agent-list"></div>
        </div>
        
        <div class="panel">
            <h3>ðŸ“‹ System Log</h3>
            <div id="system-log" class="log"></div>
        </div>
    </div>

    <!-- Load Core Systems -->
    <script src="js/core/EventBus.js"></script>
    <script src="js/core/OllamaTheaterInterface.js"></script>
    <script src="js/core/BaseAgent.js"></script>
    <script src="js/core/AgentManager.js"></script>
    
    <!-- Load Orchestration Layer -->
    <script src="js/core/OrchestrationResourceManager.js"></script>
    <script src="js/core/DecisionEngine.js"></script>
    <script src="js/core/SyncManager.js"></script>
    <script src="js/core/TaskManager.js"></script>
    <script src="js/core/ProductionOrchestrator.js?v=20250614"></script>
    
    <!-- Load All Agents -->
    <script src="js/agents/ExecutiveProducerAgent.js"></script>
    <script src="js/agents/AIDirectorAgent.js"></script>
    <script src="js/agents/AIPlaywrightAgent.js"></script>
    <script src="js/agents/TechnicalDirectorAgent.js"></script>
    <script src="js/agents/AssistantDirectorAgent.js"></script>
    <script src="js/agents/ScriptEditorAgent.js"></script>
    <script src="js/agents/MusicDirectorAgent.js"></script>
    <script src="js/agents/LightingDesignerAgent.js"></script>
    <script src="js/agents/SoundDesignerAgent.js"></script>
    <script src="js/agents/ProductionDesignerAgent.js"></script>
    <script src="js/agents/CostumeDesignerAgent.js"></script>
    <script src="js/agents/ChoreographerAgent.js"></script>
    <script src="js/agents/StageManagerAgent.js"></script>
    <script src="js/agents/VoiceCoachAgent.js"></script>
    <script src="js/agents/SetDesignerAgent.js"></script>
    <script src="js/agents/MethodActingCoachAgent.js"></script>
    <script src="js/agents/DramaturgeAgent.js"></script>
    <script src="js/agents/MusicComposerAgent.js"></script>
    <script src="js/agents/ProjectionDesignerAgent.js"></script>
    <script src="js/agents/PropsMasterAgent.js"></script>
    <script src="js/agents/MakeupArtistAgent.js"></script>
    <script src="js/agents/FightChoreographerAgent.js"></script>
    <script src="js/agents/DialectCoachAgent.js"></script>
    <script src="js/agents/MovementCoachAgent.js"></script>
    <script src="js/agents/CastingDirectorAgent.js"></script>
    <script src="js/agents/MarketingDirectorAgent.js"></script>

    <script>
        // Global state
        let systemInitialized = false;
        let agents = new Map();
        let showingAgents = true;
        
        // Initialize the demo
        function logMessage(message, agent = 'System') {
            const logElement = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-agent">${agent}:</span>
                <span class="log-message">${message}</span>
            `;
            
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateMetrics() {
            const agentCount = agents.size;
            const eventStats = window.theaterEventBus ? window.theaterEventBus.getStats() : { totalEvents: 0 };
            const systemStats = window.theaterAgentManager ? window.theaterAgentManager.getSystemStatus() : { productions: { active: 0 }, state: { healthStatus: 'Unknown' } };
            
            document.getElementById('agent-count').textContent = agentCount;
            document.getElementById('event-count').textContent = eventStats.totalEvents || 0;
            document.getElementById('production-count').textContent = systemStats.productions.active;
            document.getElementById('health-status').textContent = systemStats.state.healthStatus || 'Unknown';
            
            // Show orchestration status if available
            if (window.productionOrchestrator) {
                const orchStatus = window.productionOrchestrator.getOrchestratorStatus();
                document.getElementById('active-tasks').textContent = orchStatus.execution.activeTasks || 0;
                
                // Show current phase
                if (window.productionOrchestrator.productionWorkflow) {
                    const currentPhase = window.productionOrchestrator.productionWorkflow.phases.find(p => p.status === 'executing');
                    document.getElementById('current-phase').textContent = currentPhase ? currentPhase.name : 'Planning';
                } else {
                    document.getElementById('current-phase').textContent = 'None';
                }
            }
        }
        
        function updateAgentDisplay() {
            const agentList = document.getElementById('agent-list');
            if (!showingAgents) {
                agentList.style.display = 'none';
                return;
            }
            
            agentList.style.display = 'grid';
            agentList.innerHTML = '';
            
            const agentConfigs = [
                { name: 'Executive Producer', role: 'executive-producer', class: 'ExecutiveProducerAgent' },
                { name: 'Creative Director', role: 'creative-director', class: 'AIDirectorAgent' },
                { name: 'AI Playwright', role: 'ai-playwright', class: 'AIPlaywrightAgent' },
                { name: 'Technical Director', role: 'technical-director', class: 'TechnicalDirectorAgent' },
                { name: 'Assistant Director', role: 'assistant-director', class: 'AssistantDirectorAgent' },
                { name: 'Script Editor', role: 'script-editor', class: 'ScriptEditorAgent' },
                { name: 'Music Director', role: 'music-director', class: 'MusicDirectorAgent' },
                { name: 'Lighting Designer', role: 'lighting-designer', class: 'LightingDesignerAgent' },
                { name: 'Sound Designer', role: 'sound-designer', class: 'SoundDesignerAgent' },
                { name: 'Production Designer', role: 'production-designer', class: 'ProductionDesignerAgent' },
                { name: 'Costume Designer', role: 'costume-designer', class: 'CostumeDesignerAgent' },
                { name: 'Choreographer', role: 'choreographer', class: 'ChoreographerAgent' },
                { name: 'Stage Manager', role: 'stage-manager', class: 'StageManagerAgent' },
                { name: 'Voice Coach', role: 'voice-coach', class: 'VoiceCoachAgent' },
                { name: 'Set Designer', role: 'set-designer', class: 'SetDesignerAgent' },
                { name: 'Method Acting Coach', role: 'method-acting-coach', class: 'MethodActingCoachAgent' },
                { name: 'Dramaturge', role: 'dramaturge', class: 'DramaturgeAgent' },
                { name: 'Music Composer', role: 'music-composer', class: 'MusicComposerAgent' },
                { name: 'Projection Designer', role: 'projection-designer', class: 'ProjectionDesignerAgent' },
                { name: 'Props Master', role: 'props-master', class: 'PropsMasterAgent' },
                { name: 'Makeup Artist', role: 'makeup-artist', class: 'MakeupArtistAgent' },
                { name: 'Fight Choreographer', role: 'fight-choreographer', class: 'FightChoreographerAgent' },
                { name: 'Dialect Coach', role: 'dialect-coach', class: 'DialectCoachAgent' },
                { name: 'Movement Coach', role: 'movement-coach', class: 'MovementCoachAgent' },
                { name: 'Casting Director', role: 'casting-director', class: 'CastingDirectorAgent' },
                { name: 'Marketing Director', role: 'marketing-director', class: 'MarketingDirectorAgent' }
            ];
            
            agentConfigs.forEach(config => {
                const agent = agents.get(config.role);
                const status = agent ? (agent.state.initialized ? 'ready' : 'initializing') : 'not-loaded';
                const statusClass = status === 'ready' ? 'status-ready' : status === 'initializing' ? 'status-initializing' : 'status-error';
                
                const card = document.createElement('div');
                card.className = `agent-card ${agent ? 'connected' : ''}`;
                card.innerHTML = `
                    <div class="agent-name">${config.name}</div>
                    <div class="agent-role">${config.role}</div>
                    <div class="agent-status ${statusClass}">
                        Status: ${status}
                        ${agent ? `<br>Actions: ${agent.metrics.totalActions}` : ''}
                    </div>
                `;
                
                agentList.appendChild(card);
            });
        }
        
        async function initializeSystem() {
            if (systemInitialized) return;
            
            try {
                logMessage('Initializing AI Theater Production System...');
                
                // Initialize Agent Manager
                await window.theaterAgentManager.initialize();
                logMessage('Agent Manager initialized');
                
                // Setup event listeners for real-time updates
                setupWorkflowEventListeners();
                
                // Initialize Orchestration Layer
                logMessage('Initializing orchestration systems...');
                
                // Initialize Resource Manager
                window.orchestrationResourceManager = new OrchestrationResourceManager();
                await window.orchestrationResourceManager.initialize({
                    budget: 100000,
                    timeline: { development: 6, preProduction: 6, rehearsal: 4, technical: 1, performance: 8 }
                });
                logMessage('Resource Manager initialized');
                
                // Initialize Decision Engine
                window.decisionEngine = new DecisionEngine();
                await window.decisionEngine.initialize();
                logMessage('Decision Engine initialized');
                
                // Initialize Sync Manager
                window.syncManager = new SyncManager();
                await window.syncManager.initialize();
                logMessage('Sync Manager initialized');
                
                // Initialize Task Manager
                window.taskManager = new TaskManager();
                logMessage('Task Manager initialized');
                
                // Initialize Production Orchestrator
                window.productionOrchestrator = new ProductionOrchestrator();
                await window.productionOrchestrator.initialize();
                logMessage('Production Orchestrator initialized');
                
                logMessage('âœ… Orchestration layer fully initialized');
                
                // Create and register all agents
                const agentClasses = [
                    { class: ExecutiveProducerAgent, role: 'executive-producer' },
                    { class: AIDirectorAgent, role: 'creative-director' },
                    { class: AIPlaywrightAgent, role: 'ai-playwright' },
                    { class: TechnicalDirectorAgent, role: 'technical-director' },
                    { class: AssistantDirectorAgent, role: 'assistant-director' },
                    { class: ScriptEditorAgent, role: 'script-editor' },
                    { class: MusicDirectorAgent, role: 'music-director' },
                    { class: LightingDesignerAgent, role: 'lighting-designer' },
                    { class: SoundDesignerAgent, role: 'sound-designer' },
                    { class: ProductionDesignerAgent, role: 'production-designer' },
                    { class: CostumeDesignerAgent, role: 'costume-designer' },
                    { class: ChoreographerAgent, role: 'choreographer' },
                    { class: StageManagerAgent, role: 'stage-manager' },
                    { class: VoiceCoachAgent, role: 'voice-coach' },
                    { class: SetDesignerAgent, role: 'set-designer' },
                    { class: MethodActingCoachAgent, role: 'method-acting-coach' },
                    { class: DramaturgeAgent, role: 'dramaturge' },
                    { class: MusicComposerAgent, role: 'music-composer' },
                    { class: ProjectionDesignerAgent, role: 'projection-designer' },
                    { class: PropsMasterAgent, role: 'props-master' },
                    { class: MakeupArtistAgent, role: 'makeup-artist' },
                    { class: FightChoreographerAgent, role: 'fight-choreographer' },
                    { class: DialectCoachAgent, role: 'dialect-coach' },
                    { class: MovementCoachAgent, role: 'movement-coach' },
                    { class: CastingDirectorAgent, role: 'casting-director' },
                    { class: MarketingDirectorAgent, role: 'marketing-director' }
                ];
                
                for (const { class: AgentClass, role } of agentClasses) {
                    try {
                        const agent = new AgentClass();
                        await agent.initialize();
                        
                        agents.set(role, agent);
                        window.theaterAgentManager.registerAgent(agent);
                        
                        logMessage(`${agent.config.name} initialized successfully`, agent.config.name);
                    } catch (error) {
                        logMessage(`Failed to initialize ${role}: ${error.message}`, 'Error');
                    }
                }
                
                systemInitialized = true;
                document.getElementById('init-system').disabled = true;
                document.getElementById('start-production').disabled = false;
                
                logMessage(`System initialized with ${agents.size} agents`);
                logMessage('Ready for theatrical production!');
                
            } catch (error) {
                logMessage(`System initialization failed: ${error.message}`, 'Error');
            }
            
            updateMetrics();
            updateAgentDisplay();
        }
        
        async function startDemoProduction() {
            if (!systemInitialized) return;
            
            const production = {
                id: `demo-production-${Date.now()}`,
                title: 'AI Theater Demo Production',
                type: 'musical_theater',
                description: 'A demonstration of AI-powered theater production orchestration',
                budget: 100000,
                timeline: {
                    development: 6,
                    preProduction: 6, 
                    rehearsal: 4,
                    technical: 1,
                    performance: 8
                },
                requirements: {
                    cast_size: 8,
                    orchestra_size: 12,
                    technical_complexity: 'high'
                }
            };
            
            logMessage(`ðŸŽ­ Starting orchestrated demo production: "${production.title}"`);
            
            try {
                // Use Production Orchestrator for full workflow management
                const orchestrationResult = await window.productionOrchestrator.executeProduction(production);
                
                if (orchestrationResult) {
                    logMessage(`âœ… Production orchestration initiated successfully`);
                    logMessage(`ðŸ“Š Workflow ID: ${orchestrationResult.workflowId}`);
                    logMessage(`â° Expected completion: ${orchestrationResult.expectedCompletion?.toLocaleDateString()}`);
                    
                    // Also start through Agent Manager for agent coordination
                    const agentResult = await window.theaterAgentManager.startProduction(production);
                    
                    if (agentResult) {
                        logMessage(`ðŸŽª ${agentResult.agents.size} agents engaged in production`);
                        
                        // Show resource allocation status
                        logMessage('ðŸ’° Checking production resource allocation...');
                        
                        // Show budget status instead of double-allocating
                        const resourceStatus = window.orchestrationResourceManager.getResourceStatus();
                        logMessage(`ðŸ’° Budget allocated: $${resourceStatus.budget.allocated.toLocaleString()} of $${resourceStatus.budget.total.toLocaleString()}`);
                        logMessage(`ðŸ“Š Department allocations: ${Object.keys(resourceStatus.budget.departments).length} departments`);
                        
                        logMessage('ðŸ“‹ Creating production tasks...');
                        
                        // Create sample tasks
                        const scriptTask = window.taskManager.createTask({
                            name: 'Script Development',
                            type: 'creative',
                            priority: 'high',
                            requiredRoles: ['ai-playwright', 'script-editor'],
                            deliverables: ['final_script', 'character_descriptions'],
                            estimatedDuration: 80 // hours
                        });
                        
                        const designTask = window.taskManager.createTask({
                            name: 'Production Design',
                            type: 'design',
                            priority: 'high',
                            requiredRoles: ['production-designer', 'set-designer', 'costume-designer'],
                            deliverables: ['design_concepts', 'technical_drawings'],
                            dependencies: [scriptTask.id],
                            estimatedDuration: 120
                        });
                        
                        logMessage(`âœ… Created ${scriptTask.name} and ${designTask.name} tasks`);
                        
                        // Demonstrate coordination barriers
                        logMessage('ðŸš§ Setting up coordination barriers...');
                        
                        await window.syncManager.createBarrier('creative_alignment', {
                            requiredParticipants: ['executive-producer', 'creative-director', 'ai-playwright'],
                            timeout: 300000,
                            description: 'Creative vision alignment check'
                        });
                        
                        logMessage('ðŸŽ¯ Demo production fully orchestrated and running!');
                        
                    } else {
                        logMessage('âš ï¸ Agent coordination failed', 'Warning');
                    }
                } else {
                    logMessage('âŒ Production orchestration failed', 'Error');
                }
            } catch (error) {
                logMessage(`âŒ Production start failed: ${error.message}`, 'Error');
            }
            
            updateMetrics();
        }
        
        function toggleAgentView() {
            showingAgents = !showingAgents;
            updateAgentDisplay();
        }
        
        // Subscribe to workflow events for real-time dashboard updates
        function setupWorkflowEventListeners() {
            if (window.theaterEventBus) {
                window.theaterEventBus.subscribe('task:assigned', (data) => {
                    logMessage(`ðŸ“‹ Task assigned: ${data.task.name} to ${data.assignedAgents.length} agents`, 'Orchestrator');
                });
                
                window.theaterEventBus.subscribe('task:completed', (data) => {
                    logMessage(`âœ… Task completed: ${data.task.name}`, 'Orchestrator');
                });
                
                window.theaterEventBus.subscribe('orchestration:workflow-started', (data) => {
                    logMessage(`ðŸš€ Workflow started: ${data.workflowId}`, 'Orchestrator');
                });
                
                window.theaterEventBus.subscribe('production:phase-ready', (data) => {
                    logMessage(`ðŸŽ¯ Phase ready: ${data.phase}`, 'Orchestrator');
                });
                
                window.theaterEventBus.subscribe('production:milestone-achieved', (data) => {
                    logMessage(`ðŸ† Milestone: ${data.milestone}`, 'Orchestrator');
                });
            }
        }
        
        // Update display every 2 seconds
        setInterval(() => {
            updateMetrics();
            updateAgentDisplay();
        }, 2000);
        
        // Initial display
        updateMetrics();
        updateAgentDisplay();
        
        logMessage('AI Theater Production System Demo Ready');
        logMessage('Click "Initialize System" to start the demonstration');
    </script>
</body>
</html>