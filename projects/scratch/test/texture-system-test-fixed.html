<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texture System Integration Test (Fixed)</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }

        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 5px;
            color: #FFD700;
            font-weight: bold;
        }

        .control-group input, .control-group select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 5px;
        }

        .fabric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .fabric-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #333;
            cursor: pointer;
        }

        .fabric-card:hover {
            border-color: #4CAF50;
        }

        .fabric-card.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .fabric-card h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }

        .fabric-preview {
            width: 100%;
            height: 200px;
            background: #222;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fabric-preview canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
        }

        .fabric-info {
            font-size: 12px;
            line-height: 1.4;
        }

        .fabric-info .property {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .button:hover {
            background: #45a049;
        }

        .button.secondary {
            background: #2196F3;
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: #FFD700;
            font-style: italic;
        }

        .error {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .log-panel {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üé® Texture System Integration Test</h1>
        <p>Testing the complete procedural fabric texture generation pipeline</p>

        <div class="controls-panel">
            <div class="control-group">
                <label>Fabric Type</label>
                <select id="fabricSelect">
                    <option value="cotton">Cotton</option>
                    <option value="silk">Silk</option>
                    <option value="wool">Wool</option>
                    <option value="denim">Denim</option>
                    <option value="leather">Leather</option>
                    <option value="chiffon">Chiffon</option>
                    <option value="polyester">Polyester</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Pattern Scale</label>
                <input type="range" id="patternScale" min="0.5" max="2" step="0.1" value="1.0">
                <span id="patternValue">1.0</span>
            </div>
            
            <div class="control-group">
                <label>Noise Octaves</label>
                <input type="range" id="noiseOctaves" min="2" max="8" step="1" value="4">
                <span id="octavesValue">4</span>
            </div>
            
            <div class="control-group">
                <label>Color</label>
                <input type="color" id="fabricColor" value="#8B4513">
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="button" onclick="generateBasicTexture()" id="generateBtn">Generate Texture</button>
            <button class="button secondary" onclick="generateAllBasicTextures()" id="generateAllBtn">Generate All</button>
        </div>

        <div id="systemStatus" class="loading">System ready for basic texture generation</div>

        <div class="fabric-grid" id="fabricGrid">
            <div class="fabric-card">
                <h3>Basic Fabric Texture</h3>
                <div class="fabric-preview" id="texturePreview">
                    <div class="loading">Click "Generate Texture" to create procedural fabric</div>
                </div>
                <div class="fabric-info">
                    <div class="property">
                        <span>Type:</span>
                        <span id="currentType">Cotton</span>
                    </div>
                    <div class="property">
                        <span>Status:</span>
                        <span id="currentStatus">Ready</span>
                    </div>
                    <div class="property">
                        <span>Generation Time:</span>
                        <span id="currentTime">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-panel" id="logPanel">
            <div>üé® Basic texture generation system ready</div>
            <div>üìù This simplified version generates textures using Three.js built-in capabilities</div>
            <div>üîß No external shader files required</div>
        </div>
    </div>

    <!-- Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Simplified texture generation without external dependencies
        let scene, camera, renderer, canvas;
        let currentFabric = 'cotton';

        // Fabric configurations
        const fabricConfigs = {
            cotton: {
                name: 'Cotton',
                baseColor: '#F5F5DC',
                roughness: 0.7,
                patternFreq: 32,
                noiseStrength: 0.6
            },
            silk: {
                name: 'Silk',
                baseColor: '#FFF8DC',
                roughness: 0.2,
                patternFreq: 64,
                noiseStrength: 0.2
            },
            wool: {
                name: 'Wool',
                baseColor: '#F0E68C',
                roughness: 0.9,
                patternFreq: 16,
                noiseStrength: 0.8
            },
            denim: {
                name: 'Denim',
                baseColor: '#4169E1',
                roughness: 0.8,
                patternFreq: 24,
                noiseStrength: 0.7
            },
            leather: {
                name: 'Leather',
                baseColor: '#8B4513',
                roughness: 0.6,
                patternFreq: 8,
                noiseStrength: 0.5
            },
            chiffon: {
                name: 'Chiffon',
                baseColor: '#F0F8FF',
                roughness: 0.5,
                patternFreq: 128,
                noiseStrength: 0.3
            },
            polyester: {
                name: 'Polyester',
                baseColor: '#E6E6FA',
                roughness: 0.4,
                patternFreq: 48,
                noiseStrength: 0.3
            }
        };

        // Initialize Three.js components
        function initializeRenderer() {
            try {
                canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;

                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas,
                    preserveDrawingBuffer: true 
                });
                renderer.setSize(256, 256);

                scene = new THREE.Scene();
                camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 10);
                camera.position.z = 1;

                logMessage('‚úÖ Three.js renderer initialized successfully');
                return true;
            } catch (error) {
                logMessage(`‚ùå Failed to initialize renderer: ${error.message}`);
                return false;
            }
        }

        // Generate simple procedural fabric texture using canvas
        function generateBasicTexture() {
            const startTime = performance.now();
            
            const fabricSelect = document.getElementById('fabricSelect');
            const colorInput = document.getElementById('fabricColor');
            const patternRange = document.getElementById('patternScale');
            const octavesRange = document.getElementById('noiseOctaves');
            
            currentFabric = fabricSelect.value;
            const config = fabricConfigs[currentFabric];
            const customColor = colorInput.value;
            const patternScale = parseFloat(patternRange.value);
            const noiseOctaves = parseInt(octavesRange.value);
            
            logMessage(`üé® Generating ${config.name} texture...`);
            
            // Update status
            document.getElementById('currentType').textContent = config.name;
            document.getElementById('currentStatus').textContent = 'Generating...';
            
            try {
                // Create texture using canvas-based noise
                const textureCanvas = generateCanvasTexture(config, customColor, patternScale, noiseOctaves);
                
                // Display in preview
                const preview = document.getElementById('texturePreview');
                preview.innerHTML = '';
                preview.appendChild(textureCanvas);
                
                const generationTime = performance.now() - startTime;
                
                // Update status
                document.getElementById('currentStatus').textContent = 'Complete';
                document.getElementById('currentTime').textContent = `${generationTime.toFixed(1)}ms`;
                
                logMessage(`‚úÖ ${config.name} texture generated in ${generationTime.toFixed(1)}ms`);
                
            } catch (error) {
                logMessage(`‚ùå Failed to generate texture: ${error.message}`);
                document.getElementById('currentStatus').textContent = 'Error';
                
                const preview = document.getElementById('texturePreview');
                preview.innerHTML = '<div class="error">Generation failed</div>';
            }
        }

        // Generate canvas-based procedural texture
        function generateCanvasTexture(config, customColor, patternScale, octaves) {
            const size = 256;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            canvas.style.width = '200px';
            canvas.style.height = '200px';
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(size, size);
            const data = imageData.data;
            
            // Parse custom color
            const color = hexToRgb(customColor);
            const baseColor = color || hexToRgb(config.baseColor);
            
            // Generate noise-based texture
            for (let x = 0; x < size; x++) {
                for (let y = 0; y < size; y++) {
                    const index = (y * size + x) * 4;
                    
                    // Generate noise value
                    let noise = 0;
                    let amplitude = 1;
                    let frequency = config.patternFreq * patternScale / size;
                    let maxValue = 0;
                    
                    for (let i = 0; i < octaves; i++) {
                        noise += amplitude * simplexNoise(x * frequency, y * frequency);
                        maxValue += amplitude;
                        amplitude *= 0.5;
                        frequency *= 2;
                    }
                    
                    noise = noise / maxValue;
                    noise = (noise + 1) * 0.5; // Normalize to 0-1
                    
                    // Apply fabric-specific pattern
                    let pattern = 1.0;
                    
                    if (currentFabric === 'cotton' || currentFabric === 'denim') {
                        // Weave pattern
                        const warp = Math.sin(x * 0.3) > 0 ? 1 : 0;
                        const weft = Math.sin(y * 0.3) > 0 ? 1 : 0;
                        pattern = warp === weft ? 0.8 : 1.2;
                    } else if (currentFabric === 'leather') {
                        // Grain pattern
                        pattern = 0.7 + 0.6 * Math.abs(noise - 0.5);
                    } else if (currentFabric === 'wool') {
                        // Fuzzy pattern
                        pattern = 0.6 + 0.8 * noise * noise;
                    }
                    
                    // Apply noise and pattern
                    const finalNoise = noise * config.noiseStrength * pattern;
                    
                    // Calculate final color
                    const r = Math.max(0, Math.min(255, baseColor.r * (0.7 + 0.6 * finalNoise)));
                    const g = Math.max(0, Math.min(255, baseColor.g * (0.7 + 0.6 * finalNoise)));
                    const b = Math.max(0, Math.min(255, baseColor.b * (0.7 + 0.6 * finalNoise)));
                    
                    data[index] = r;     // Red
                    data[index + 1] = g; // Green
                    data[index + 2] = b; // Blue
                    data[index + 3] = 255; // Alpha
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        // Simple noise function (simplified Perlin-like)
        function simplexNoise(x, y) {
            const p = [151,160,137,91,90,15,
                131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,
                190, 6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,
                88,237,149,56,87,174,20,125,136,171,168, 68,175,74,165,71,134,139,48,27,166,
                77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,
                102,143,54, 65,25,63,161, 1,216,80,73,209,76,132,187,208, 89,18,169,200,196,
                135,130,116,188,159,86,164,100,109,198,173,186, 3,64,52,217,226,250,124,123,
                5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,
                223,183,170,213,119,248,152, 2,44,154,163, 70,221,153,101,155,167, 43,172,9,
                129,22,39,253, 19,98,108,110,79,113,224,232,178,185, 112,104,218,246,97,228,
                251,34,242,193,238,210,144,12,191,179,162,241, 81,51,145,235,249,14,239,107,
                49,192,214, 31,181,199,106,157,184, 84,204,176,115,121,50,45,127, 4,150,254,
                138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];
            
            const xi = Math.floor(x) & 255;
            const yi = Math.floor(y) & 255;
            const xf = x - Math.floor(x);
            const yf = y - Math.floor(y);
            
            const u = fade(xf);
            const v = fade(yf);
            
            const aa = p[p[xi] + yi];
            const ab = p[p[xi] + yi + 1];
            const ba = p[p[xi + 1] + yi];
            const bb = p[p[xi + 1] + yi + 1];
            
            const x1 = lerp(grad(aa, xf, yf), grad(ba, xf - 1, yf), u);
            const x2 = lerp(grad(ab, xf, yf - 1), grad(bb, xf - 1, yf - 1), u);
            
            return lerp(x1, x2, v);
        }

        function fade(t) {
            return t * t * t * (t * (t * 6 - 15) + 10);
        }

        function lerp(a, b, t) {
            return a + t * (b - a);
        }

        function grad(hash, x, y) {
            const h = hash & 15;
            const u = h < 8 ? x : y;
            const v = h < 4 ? y : h === 12 || h === 14 ? x : 0;
            return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);
        }

        // Convert hex color to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // Generate all fabric types
        function generateAllBasicTextures() {
            logMessage('üè≠ Generating all fabric types...');
            
            const fabricSelect = document.getElementById('fabricSelect');
            const originalValue = fabricSelect.value;
            
            let index = 0;
            const fabrics = Object.keys(fabricConfigs);
            
            function generateNext() {
                if (index < fabrics.length) {
                    fabricSelect.value = fabrics[index];
                    generateBasicTexture();
                    index++;
                    setTimeout(generateNext, 500); // Delay between generations
                } else {
                    fabricSelect.value = originalValue;
                    logMessage('‚úÖ All fabric types generated');
                }
            }
            
            generateNext();
        }

        // Set up control event listeners
        function setupControls() {
            const patternRange = document.getElementById('patternScale');
            const patternValue = document.getElementById('patternValue');
            const octavesRange = document.getElementById('noiseOctaves');
            const octavesValue = document.getElementById('octavesValue');
            
            patternRange.addEventListener('input', (e) => {
                patternValue.textContent = e.target.value;
            });
            
            octavesRange.addEventListener('input', (e) => {
                octavesValue.textContent = e.target.value;
            });
        }

        // Add message to log panel
        function logMessage(message) {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Initialize system
        window.addEventListener('load', () => {
            logMessage('üöÄ Initializing basic texture generation system...');
            
            if (typeof THREE === 'undefined') {
                logMessage('‚ùå Three.js not loaded');
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="error">‚ùå Three.js failed to load</div>';
                return;
            }
            
            logMessage('‚úÖ Three.js loaded successfully');
            
            setupControls();
            logMessage('‚úÖ System ready for texture generation');
            
            document.getElementById('systemStatus').innerHTML = 
                '<div class="success">‚úÖ Basic texture generation system ready</div>';
        });
    </script>
</body>
</html>